@*
@file        UyeHome.cshtml
@description Üye ana sayfa (dashboard) ekranıdır.
             Üye randevularını görüntüler/oluşturur ve Yapay Zeka öneri modülüne erişir.
             Dönem projesi kapsamında API üzerinden (JSON) kendi randevularını
             listeleyen örnek bir bölüm içerir.

@course      BSM 311 Web Programlama
@assignment  Dönem Projesi – MutluSporSalonu
@date        20.12.2025
@author      D255012008 - Serkan Mutlu
*@

@{
    ViewData["Title"] = "Üye Ana Sayfa";
}

<div class="container mt-4">

    <!-- KARŞILAMA / ANA BAŞLIK -->
    <div class="row align-items-center mb-5">
        <div class="col-md-7">
            <h1 class="display-5 fw-bold mb-3">
                Hoş Geldiniz
            </h1>

            <p class="lead">
                Randevularınızı buradan yönetin, antrenör ve hizmet seçin.
                Yapay zekâ destekli egzersiz ve beslenme önerileriyle hedefinize
                daha planlı ilerleyin.
            </p>

            <div class="d-flex flex-wrap gap-2 mt-3">
                <a asp-controller="Randevu" asp-action="Index" class="btn btn-success">
                    Randevularım
                </a>
                <a asp-controller="Randevu" asp-action="Create" class="btn btn-outline-primary">
                    Yeni Randevu Oluştur
                </a>
                <a asp-controller="YapayZeka" asp-action="Oneri" class="btn btn-outline-secondary">
                    AI Öneri Al
                </a>
            </div>

            <p class="small text-muted mt-3 mb-0">
                İpucu: Daha iyi öneriler için profil bilgilerinizi güncel tutun.
            </p>
        </div>

        <div class="col-md-5 mt-4 mt-md-0">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h5 class="card-title mb-3">Bugün Yapabilecekleriniz</h5>
                    <ul class="list-unstyled small mb-0">
                        <li class="mb-2">Mevcut randevularınızı kontrol edin</li>
                        <li class="mb-2">Yeni bir antrenör ve hizmet seçin</li>
                        <li class="mb-2">AI destekli egzersiz önerisi alın</li>
                        <li class="mb-2">Hedeflerinize göre planınızı güncelleyin</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- API ÜZERİNDEN RANDEVULARIM -->
    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white d-flex align-items-center">
                    <span>API ile Randevularım (LINQ + JSON)</span>
                    <span class="ms-auto small opacity-75">/api/randevuapi/benim</span>
                </div>

                <div class="card-body">
                    <p class="text-muted small mb-3">
                        Bu bölümde randevular, veritabanından LINQ ile çekilerek
                        API üzerinden JSON formatında getirilir ve tabloda gösterilir.
                    </p>

                    <div class="d-flex flex-wrap gap-2 mb-3">
                        <!-- API çağrısını başlatır -->
                        <button type="button" class="btn btn-outline-primary" id="btnApiRandevuGetir">
                            Randevularımı API’den Getir
                        </button>

                        <!-- Ekrandaki tabloyu temizler -->
                        <button type="button" class="btn btn-outline-secondary" id="btnApiRandevuTemizle">
                            Temizle
                        </button>
                    </div>

                    <div id="apiRandevuDurum" class="small text-muted mb-2"></div>

                    <div class="table-responsive" id="apiRandevuAlan" style="display:none;">
                        <table class="table table-sm table-bordered table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Antrenör</th>
                                    <th>Hizmet</th>
                                    <th>Salon</th>
                                    <th>Tarih</th>
                                    <th>Saat</th>
                                    <th>Ücret</th>
                                    <th>Onay</th>
                                </tr>
                            </thead>
                            <tbody id="apiRandevuTbody"></tbody>
                        </table>
                    </div>

                    <div class="alert alert-light small mt-3 mb-0">
                        Not: Eğer bu bölüm 404 hatası verirse,
                        RandevuApiController içinde
                        <strong>GET /api/randevuapi/benim</strong>
                        endpoint’i tanımlı değildir.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- HIZLI ERİŞİM KARTLARI -->
    <div class="row g-4 mb-4">

        <div class="col-md-3">
            <div class="card h-100 shadow-sm">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">Randevularım</h5>
                    <p class="card-text small flex-grow-1">
                        Geçmiş ve yaklaşan randevularınızı görüntüleyin.
                    </p>
                    <a asp-controller="Randevu" asp-action="Index" class="btn btn-outline-primary mt-2">
                        Görüntüle
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card h-100 shadow-sm">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">Yeni Randevu</h5>
                    <p class="card-text small flex-grow-1">
                        Uygun hizmet ve antrenörü seçerek randevu oluşturun.
                    </p>
                    <a asp-controller="Randevu" asp-action="Create" class="btn btn-outline-primary mt-2">
                        Oluştur
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card h-100 shadow-sm">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">Antrenörler</h5>
                    <p class="card-text small flex-grow-1">
                        Antrenörlerin uzmanlık alanlarını ve müsaitliklerini inceleyin.
                    </p>
                    <a asp-controller="Antrenor" asp-action="Index" class="btn btn-outline-primary mt-2">
                        Listele
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card h-100 shadow-sm">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">Hizmetler</h5>
                    <p class="card-text small flex-grow-1">
                        Sunulan hizmetleri süre ve ücret bilgileriyle görüntüleyin.
                    </p>
                    <a asp-controller="Hizmet" asp-action="Index" class="btn btn-outline-primary mt-2">
                        Listele
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- ALT BİLGİ -->
    <div class="alert alert-light small" role="alert">
        Sağlıklı yaşam bir süreçtir. Düzenli randevu ve doğru planlama ile
        daha verimli sonuçlar elde edilebilir.
    </div>

</div>

@section Scripts {
    <script>
        const btnGetir = document.getElementById("btnApiRandevuGetir");
        const btnTemizle = document.getElementById("btnApiRandevuTemizle");

        const durum = document.getElementById("apiRandevuDurum");
        const alan = document.getElementById("apiRandevuAlan");
        const tbody = document.getElementById("apiRandevuTbody");

        function temizle() {
            tbody.innerHTML = "";
            alan.style.display = "none";
            durum.innerText = "";
        }

        function badge(onay) {
            if (onay === true) return `<span class="badge bg-success">Onaylandı</span>`;
            return `<span class="badge bg-warning text-dark">Beklemede</span>`;
        }

        function satirEkle(r) {
            const tr = document.createElement("tr");

            const ant = r.antrenorAdSoyad ?? r.AntrenorAdSoyad ?? "-";
            const hizmet = r.hizmetAdi ?? r.HizmetAdi ?? "-";
            const salon = r.salonAdi ?? r.SalonAdi ?? "-";

            const tarih = r.tarih ?? r.Tarih ?? "-";
            const bas = r.baslangic ?? r.Baslangic ?? "-";
            const bit = r.bitis ?? r.Bitis ?? "-";

            const ucret = r.ucret ?? r.Ucret ?? "-";
            const onay = r.onaylandiMi ?? r.OnaylandiMi ?? r.RandevuOnaylandiMi;

            tr.innerHTML = `
                <td>${ant}</td>
                <td>${hizmet}</td>
                <td>${salon}</td>
                <td>${tarih}</td>
                <td>${bas} - ${bit}</td>
                <td>${ucret} ₺</td>
                <td>${badge(onay)}</td>
            `;
            tbody.appendChild(tr);
        }

        async function getir() {
            temizle();
            durum.innerText = "API çağrısı yapılıyor...";

            const url = "/api/randevuapi/benim";

            try {
                const res = await fetch(url);
                const text = await res.text();

                if (!res.ok) {
                    durum.innerText = `Hata: ${text}`;
                    return;
                }

                const data = JSON.parse(text);

                if (!data || data.length === 0) {
                    durum.innerText = "API'den randevu bulunamadı.";
                    return;
                }

                for (const r of data) {
                    satirEkle(r);
                }

                durum.innerText = `${data.length} randevu yüklendi.`;
                alan.style.display = "block";

            } catch (e) {
                durum.innerText = "API çağrısı başarısız.";
            }
        }

        btnGetir?.addEventListener("click", getir);
        btnTemizle?.addEventListener("click", temizle);
    </script>
}
