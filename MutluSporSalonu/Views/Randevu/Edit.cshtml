@*
@file        Edit.cshtml
@description Randevu düzenleme ekranıdır.
             Admin kullanıcılar tüm alanları (üye seçimi ve onay durumu dahil) düzenleyebilir.
             Üye rolündeki kullanıcılar sadece kendi randevusunu düzenler; onay durumu sadece görüntülenir.
             Salon/Antrenör/Hizmet seçimleri dependent dropdown endpointleri ile birbirini filtreler.
@course      BSM 311 Web Programlama
@assignment  Dönem Projesi – MutluSporSalonu
@date        20.12.2025
@author      D255012008 - Serkan Mutlu
*@

@model MutluSporSalonu.Models.Randevu

@{
    ViewData["Title"] = "Randevu Düzenle";
}

<div class="container mt-4">
    <h2 class="mb-4">Randevu Düzenle</h2>

    <form asp-action="Edit" method="post" class="row g-3">
        @Html.AntiForgeryToken()

        <div asp-validation-summary="All" class="text-danger mb-2"></div>

        @* Düzenlenecek randevunun ID'si form ile taşınır *@
        <input type="hidden" asp-for="RandevuID" />

        <div class="col-md-4">
            <label class="form-label">Üye</label>
            <select asp-for="UyeID" asp-items="ViewBag.Uyeler" class="form-select" id="uyeSecim">
                <option value="">-- Üye Seçiniz --</option>
            </select>
            <span asp-validation-for="UyeID" class="text-danger"></span>
        </div>

        <div class="col-md-4">
            <label class="form-label">Antrenör</label>
            <select asp-for="AntrenorID" asp-items="ViewBag.Antrenorler" class="form-select" id="antrenorSecim">
                <option value="">-- Antrenör Seçiniz --</option>
            </select>
            <span asp-validation-for="AntrenorID" class="text-danger"></span>
        </div>

        <div class="col-md-4">
            <label class="form-label">Hizmet</label>
            <select asp-for="HizmetID" asp-items="ViewBag.Hizmetler" class="form-select" id="hizmetSecim">
                <option value="">-- Hizmet Seçiniz --</option>
            </select>
            <span asp-validation-for="HizmetID" class="text-danger"></span>
        </div>

        <div class="col-md-4">
            <label asp-for="SalonID" class="form-label">Salon</label>
            <select asp-for="SalonID" asp-items="ViewBag.SporSalonlari" class="form-select" id="salonSecim">
                <option value="">-- Salon Seçiniz --</option>
            </select>
            <span asp-validation-for="SalonID" class="text-danger"></span>
        </div>

        <div class="col-md-4">
            <label asp-for="RandevuTarihi" class="form-label">Tarih</label>
            <input asp-for="RandevuTarihi" class="form-control" type="date" />
            <span asp-validation-for="RandevuTarihi" class="text-danger"></span>
        </div>

        <div class="col-md-2">
            <label asp-for="RandevuBaslangicSaati" class="form-label">Başlangıç</label>
            <input asp-for="RandevuBaslangicSaati" class="form-control" type="time" id="baslangicSaat" />
            <span asp-validation-for="RandevuBaslangicSaati" class="text-danger"></span>
        </div>

        <div class="col-md-2">
            <label asp-for="RandevuBitisSaati" class="form-label">Bitiş</label>
            <input asp-for="RandevuBitisSaati" class="form-control" type="time" id="bitisSaat" />
            <span asp-validation-for="RandevuBitisSaati" class="text-danger"></span>
        </div>

        <div class="col-md-4">
            <label asp-for="RandevuUcret" class="form-label">Ücret (₺)</label>
            <input asp-for="RandevuUcret" class="form-control" type="number" step="0.01" min="0" />
            <span asp-validation-for="RandevuUcret" class="text-danger"></span>
            <small class="text-muted">İstersen hizmet ücretine göre otomatik güncelleyebilirsin.</small>
        </div>

        <div class="col-md-4">
            <label class="form-label">Onay Durumu</label>

            @if (User.IsInRole("Admin"))
            {
                @* Admin: Onay durumunu değiştirebilir *@
                <select asp-for="RandevuOnaylandiMi" class="form-select">
                    <option value="false">Beklemede</option>
                    <option value="true">Onaylandı</option>
                </select>
            }
            else
            {
                @* Üye: Onay durumunu sadece görür (controller DB değerini korur) *@
                <input type="text"
                       class="form-control"
                       value="@(Model.RandevuOnaylandiMi ? "Onaylandı" : "Beklemede")"
                       disabled />

                @* Model binding bozulmasın diye hidden gönderilir *@
                <input type="hidden" asp-for="RandevuOnaylandiMi" />
            }

            <span asp-validation-for="RandevuOnaylandiMi" class="text-danger"></span>
        </div>

        <div class="col-12">
            <label asp-for="RandevuAciklama" class="form-label"></label>
            <textarea asp-for="RandevuAciklama" class="form-control" rows="3"></textarea>
            <span asp-validation-for="RandevuAciklama" class="text-danger"></span>
        </div>

        <div class="col-12 d-flex justify-content-between mt-4">
            <a asp-action="Index" class="btn btn-secondary">Geri Dön</a>
            <button type="submit" class="btn btn-warning">Güncelle</button>
        </div>

    </form>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        const antrenorSel = document.getElementById("antrenorSecim");
        const hizmetSel = document.getElementById("hizmetSecim");
        const salonSel = document.getElementById("salonSecim");

        function fillSelect(selectEl, items, placeholder) {
            const current = selectEl.value;

            selectEl.innerHTML = "";
            const opt0 = document.createElement("option");
            opt0.value = "";
            opt0.textContent = placeholder;
            selectEl.appendChild(opt0);

            (items || []).forEach(i => {
                const opt = document.createElement("option");
                opt.value = i.id;
                opt.textContent = i.name;
                selectEl.appendChild(opt);
            });

            if ([...selectEl.options].some(o => o.value === current)) {
                selectEl.value = current;
            }
        }

        async function onAntrenorChanged() {
            const id = antrenorSel.value;
            if (!id) return;

            const res = await fetch(`/Randevu/GetOptionsByAntrenor?antrenorId=${id}`);
            const data = await res.json();

            // Antrenör seçilince: salon + hizmet listesi antrenöre göre filtrelenir
            fillSelect(salonSel, data.salons, "-- Salon Seçiniz --");
            fillSelect(hizmetSel, data.services, "-- Hizmet Seçiniz --");
        }

        async function onSalonChanged() {
            const id = salonSel.value;
            if (!id) return;

            const res = await fetch(`/Randevu/GetOptionsBySalon?salonId=${id}`);
            const data = await res.json();

            // Salon seçilince: antrenör + hizmet listesi salona göre filtrelenir
            fillSelect(antrenorSel, data.antrenorler, "-- Antrenör Seçiniz --");
            fillSelect(hizmetSel, data.services, "-- Hizmet Seçiniz --");
        }

        antrenorSel?.addEventListener("change", onAntrenorChanged);
        salonSel?.addEventListener("change", onSalonChanged);

        window.addEventListener("load", () => {
            // Edit ekranında seçimler doluysa ilgili filtrelemeyi sayfa açılışında uygula
            if (antrenorSel?.value) onAntrenorChanged();
            else if (salonSel?.value) onSalonChanged();
        });
    </script>
}
