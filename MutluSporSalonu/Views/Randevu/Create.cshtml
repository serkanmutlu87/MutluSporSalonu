@*
@file        Create.cshtml
@description Yeni randevu oluşturma ekranıdır.
             Form verileri RandevuController içindeki Create action'ına gönderilir.
             Antrenör/Salon seçimine göre bağımlı dropdown'lar (fetch ile) filtrelenir.
             Hizmet seçimine göre hizmet süresi API'den çekilerek bitiş saati otomatik hesaplanır.

@course      BSM 311 Web Programlama
@assignment  Dönem Projesi – MutluSporSalonu
@date        20.12.2025
@author      D255012008 - Serkan Mutlu
*@

@model MutluSporSalonu.Models.Randevu

@{
    ViewData["Title"] = "Yeni Randevu Oluştur";
}

<div class="container mt-4">
    <h2 class="mb-4">Yeni Randevu Oluştur</h2>

    <form asp-action="Create" method="post" class="row g-3">
        @Html.AntiForgeryToken()

        <div asp-validation-summary="All" class="text-danger mb-2"></div>

        <div class="col-md-4">
            <label class="form-label">Üye</label>
            <select asp-for="UyeID" asp-items="ViewBag.Uyeler" class="form-select" id="uyeSecim">
                <option value="">-- Üye Seçiniz --</option>
            </select>
            <span asp-validation-for="UyeID" class="text-danger"></span>
        </div>

        <div class="col-md-4">
            <label class="form-label">Antrenör</label>
            <select asp-for="AntrenorID" asp-items="ViewBag.Antrenorler" class="form-select" id="antrenorSecim">
                <option value="">-- Antrenör Seçiniz --</option>
            </select>
            <span asp-validation-for="AntrenorID" class="text-danger"></span>
        </div>

        <div class="col-md-4">
            <label class="form-label">Hizmet</label>
            <select asp-for="HizmetID" asp-items="ViewBag.Hizmetler" class="form-select" id="hizmetSecim">
                <option value="">-- Hizmet Seçiniz --</option>
            </select>
            <span asp-validation-for="HizmetID" class="text-danger"></span>
        </div>

        <div class="col-md-4">
            <label asp-for="SalonID" class="form-label">Salon</label>
            <select asp-for="SalonID" asp-items="ViewBag.SporSalonlari" class="form-select" id="salonSecim">
                <option value="">-- Salon Seçiniz --</option>
            </select>
            <span asp-validation-for="SalonID" class="text-danger"></span>
        </div>

        <div class="col-md-4">
            <label asp-for="RandevuTarihi" class="form-label">Tarih</label>
            <input asp-for="RandevuTarihi" class="form-control" type="date" />
            <span asp-validation-for="RandevuTarihi" class="text-danger"></span>
        </div>

        <div class="col-md-2">
            <label asp-for="RandevuBaslangicSaati" class="form-label">Başlangıç</label>
            <input asp-for="RandevuBaslangicSaati" class="form-control" type="time" id="baslangicSaat" />
            <span asp-validation-for="RandevuBaslangicSaati" class="text-danger"></span>
        </div>

        <div class="col-md-2">
            <label asp-for="RandevuBitisSaati" class="form-label">Bitiş</label>
            <input asp-for="RandevuBitisSaati" class="form-control" type="time" id="bitisSaat" />
            <span asp-validation-for="RandevuBitisSaati" class="text-danger"></span>
        </div>

        <div class="col-12 d-flex justify-content-between mt-4">
            <a asp-action="Index" class="btn btn-secondary">Geri Dön</a>
            <button type="submit" class="btn btn-success">Kaydet</button>
        </div>

    </form>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        // Antrenör/Salon seçimine göre diğer listeleri filtrelemek için kullanılan select referansları
        const antrenorSel = document.getElementById("antrenorSecim");
        const hizmetSel = document.getElementById("hizmetSecim");
        const salonSel = document.getElementById("salonSecim");

        // Select içeriğini dinamik olarak doldurur (placeholder + gelen item listesi)
        function fillSelect(selectEl, items, placeholder) {
            const current = selectEl.value;

            selectEl.innerHTML = "";
            const opt0 = document.createElement("option");
            opt0.value = "";
            opt0.textContent = placeholder;
            selectEl.appendChild(opt0);

            (items || []).forEach(i => {
                const opt = document.createElement("option");
                opt.value = i.id;
                opt.textContent = i.name;
                selectEl.appendChild(opt);
            });

            // önceki seçim hâlâ listede varsa koru (sayfa refresh / edit senaryosu)
            if ([...selectEl.options].some(o => o.value === current)) {
                selectEl.value = current;
            }
        }

        // Antrenör seçilince: o antrenöre uygun salon + hizmetleri API'den çekip dropdown'ları günceller
        async function onAntrenorChanged() {
            const id = antrenorSel.value;
            if (!id) return;

            const res = await fetch(`/Randevu/GetOptionsByAntrenor?antrenorId=${id}`);
            const data = await res.json();

            fillSelect(salonSel, data.salons, "-- Salon Seçiniz --");
            fillSelect(hizmetSel, data.services, "-- Hizmet Seçiniz --");
        }

        // Salon seçilince: o salona uygun antrenör + hizmetleri API'den çekip dropdown'ları günceller
        async function onSalonChanged() {
            const id = salonSel.value;
            if (!id) return;

            const res = await fetch(`/Randevu/GetOptionsBySalon?salonId=${id}`);
            const data = await res.json();

            fillSelect(antrenorSel, data.antrenorler, "-- Antrenör Seçiniz --");
            fillSelect(hizmetSel, data.services, "-- Hizmet Seçiniz --");
        }

        antrenorSel?.addEventListener("change", onAntrenorChanged);
        salonSel?.addEventListener("change", onSalonChanged);

        // Sayfa ilk açıldığında seçili değer varsa dropdown'ları ona göre senkronlar (edit / geri dönüş senaryosu)
        window.addEventListener("load", () => {
            if (antrenorSel?.value) onAntrenorChanged();
            else if (salonSel?.value) onSalonChanged();
        });

        // Hizmet seçilince: hizmet süresini API'den çekip globalde tutar (bitiş saati hesabında kullanılacak)
        document.getElementById("hizmetSecim").addEventListener("change", function () {
            var secilenId = this.value;
            if (!secilenId) return;

            fetch('/Api/HizmetApi/' + secilenId)
                .then(r => r.json())
                .then(data => {
                    window.hizmetSuresi = data.sure;
                })
                .catch(() => { window.hizmetSuresi = null; });
        });

        // Başlangıç saati girilince: hizmet süresine göre bitiş saatini otomatik hesaplar ve input'a yazar
        document.getElementById("baslangicSaat").addEventListener("input", function () {
            if (!window.hizmetSuresi) return;

            var bas = this.value;
            if (!bas) return;

            var [saat, dakika] = bas.split(":");
            var basDate = new Date(0, 0, 0, parseInt(saat), parseInt(dakika));

            basDate.setMinutes(basDate.getMinutes() + window.hizmetSuresi);

            var yeniSaat = basDate.getHours().toString().padStart(2, "0");
            var yeniDakika = basDate.getMinutes().toString().padStart(2, "0");

            document.getElementById("bitisSaat").value = yeniSaat + ":" + yeniDakika;
        });
    </script>
}
